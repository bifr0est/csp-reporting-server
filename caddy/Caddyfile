{
    # Caddy admin endpoint. Disabled for security.
    admin off
}

# Get domain name from environment variable, fallback to localhost
{$DOMAIN_NAME:-localhost} {

    # Rate limit CSP endpoint: 5 requests/sec (10 events per 2s), per IP
    rate_limit {
        zone csp {
            match {
                path /csp-report
            }
            key {remote_host}
            window 2s
            events 10
        }
    }

    route /csp-report {
        @post_csp_report {
            method POST
        }
        reverse_proxy @post_csp_report http://csp-receiver:5000 {
            header_up Host {host}
            header_up X-Real-IP {remote_ip}
            header_up X-Forwarded-For {remote_ip}
            header_up X-Forwarded-Proto {scheme}
        }

        # For any other method (like GET) to /csp-report, return 418
        respond * 418 {
            close
        }
    }

    # Health check endpoint
    respond /health "OK" 200

    # Set security headers for all responses
    header {
        -Server
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        X-XSS-Protection "1; mode=block"
        # Strict-Transport-Security is often added automatically by Caddy
        # but can be specified here if needed.
    }

    # Reject all other requests
    respond "Not Found" 404
}